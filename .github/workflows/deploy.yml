name: Desplega a producci√≥ (riders)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Actualitza riders.kinosonik.com
    runs-on: ubuntu-latest

    steps:
      - name: Checkout del codi
        uses: actions/checkout@v4

      - name: Desplega via SSH
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: riders.kinosonik.com
          username: deploy
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
              cd /var/www/html || exit 1

              echo "Configurant Git..."
              git config --global credential.helper store
              git config --global user.email "ci@kinosonik.com"
              git config --global user.name "GitHub Actions"
              git remote set-url origin https://github.com/Kinosonik/kinosonik.git

              echo "Actualitzant codi..."
              git fetch --all
              git reset --hard origin/main
              git clean -fd

              echo "Permisos..."
              sudo chown -R kinosonik:www-data /var/www/html
              find /var/www/html -type d -exec sudo chmod 775 {} \;
              find /var/www/html -type f -exec sudo chmod 664 {} \;

              echo "Netejant OPcache..."
              sudo /usr/bin/php -r 'if (function_exists("opcache_reset")) { opcache_reset(); echo "OPcache reset complet.\n"; } else { echo "OPcache no disponible.\n"; }'

              echo "Recarregant serveis..."
              sudo systemctl reload php8.3-fpm
              sudo systemctl reload nginx

              echo "Desplegament completat $(date)"
              git log -1 --pretty=format:'Commit desplegat: %h %s (%ci)'

